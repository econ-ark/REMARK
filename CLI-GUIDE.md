# CLI Tool Guide

**‚ö†Ô∏è IMPORTANT**: The REMARK CLI tool (`cli.py`) is for **REMARK VALIDATION AND TESTING**, not website generation. The website (econ-ark.org) is generated by a separate system (`populate_remarks.py`).

## üîß CLI Tool vs üåê Website Generation

**This CLI tool is used for:**

- ‚úÖ Validating REMARK compliance (reproducibility standards)
- ‚úÖ Testing `reproduce.sh` scripts
- ‚úÖ Building and testing environments
- ‚úÖ Editorial review workflow

**This CLI tool is NOT used for:**

- ‚ùå Generating website content (that's `populate_remarks.py`)
- ‚ùå Creating `_materials/*.md` files
- ‚ùå Website troubleshooting

The REMARK CLI tool (`cli.py`) provides automated operations for cloning, validating, building, and executing REMARKs. This tool is essential for maintainers and anyone working with multiple REMARKs.

## Installation Requirements

```bash
# From REMARK repository root
pip install -r requirements.txt
```

Required dependencies:

- Python 3.9+
- PyYAML
- Docker (for docker builds)
- Conda (for conda builds)
- repo2docker (for docker operations)

## Core Commands

### 1. Pull/Clone REMARKs

Download REMARK repositories locally:

```bash
# Clone all REMARKs
python cli.py pull --all

# Clone specific REMARKs
python cli.py pull REMARKs/BufferStockTheory.yml REMARKs/beyond-the-streetlight.yml

# Pull updates for already cloned REMARKs
python cli.py pull --all  # Updates existing repos
```

**What it does:**

- Creates `_REMARK/repos/` directory structure
- Clones repositories from GitHub URLs in catalog
- Checks out specific tags if specified in metadata
- Updates existing repositories if already cloned

### 2. Lint/Validate REMARKs

Check REMARK compliance against standards:

```bash
# Check all REMARKs
python cli.py lint --all

# Check specific REMARKs
python cli.py lint REMARKs/BufferStockTheory.yml

# Include optional files in validation
python cli.py lint --all --include-optional
```

**What it does:**

- Parses `STANDARD.md` for required file structure
- Checks each REMARK for missing required files
- Reports compliance issues with specific missing files
- Optionally validates optional files (ending with `?`)

**üö® CRITICAL**: Lint results show **REMARK COMPLIANCE** (reproducibility), NOT website functionality:

- ‚ùå "missing reproduce.sh" = Cannot reproduce research (REMARK issue)
- ‚úÖ **Does NOT mean** = Website won't work (website only needs `CITATION.cff`)
- ‚ùå "missing binder/environment.yml" = Cannot build execution environment
- ‚úÖ **Does NOT mean** = Website display problem

**Example output:**
```yml
------------------ REMARKs/BufferStockTheory.yml ------------------
/path/to/_REMARK/repos/BufferStockTheory
- missing reproduce_min.sh
- missing binder/environment.yml
```

### 3. Build Environments

Create reproducible execution environments:

```bash
# Build conda environments for all REMARKs
python cli.py build conda --all

# Build docker images for specific REMARKs
python cli.py build docker REMARKs/BufferStockTheory.yml

# Use parallel processing (default: 4 jobs)
python cli.py build conda --all --jobs 8
```

**Conda builds:**

- Creates `./.condaenv` in each repository
- Uses `binder/environment.yml` for dependencies
- Isolated environment per REMARK

**Docker builds:**

- Uses repo2docker (same as MyBinder)
- Creates tagged Docker images
- Supports multi-language REMARKs

### 4. Execute REMARKs

Run reproduction scripts in built environments:

```bash
# Execute all REMARKs using conda
python cli.py execute conda --all

# Execute specific REMARKs using docker
python cli.py execute docker REMARKs/BufferStockTheory.yml

# Force use of reproduce.sh (ignore reproduce_min.sh)
python cli.py execute conda --all --no-min

# Parallel execution
python cli.py execute conda --all --jobs 2
```

**Script selection:**

1. Uses `reproduce_min.sh` if available (faster)
2. Falls back to `reproduce.sh`
3. `--no-min` forces `reproduce.sh`

**Output:**

- Logs stored in `_REMARK/logs/execute/`
- Return codes tracked for success/failure
- Stdout/stderr captured per REMARK

### 5. View Logs

Check results from build/execute operations:

```bash
# Show all recent results
python cli.py logs

# Show results for specific REMARKs
python cli.py logs REMARKs/BufferStockTheory.yml
```

**Example output:**
```bash
build
BufferStockTheory         = 0
beyond-the-streetlight    = 1

execute  
BufferStockTheory         = 0
beyond-the-streetlight    = 0
```

Return codes: `0` = success, `non-zero` = failure

### 6. Clean Environments

Remove built environments and data:

```bash
# Remove conda environments
python cli.py clean conda --all

# Remove docker images
python cli.py clean docker --all

# Remove cloned repositories
python cli.py clean repo --all
```

## Advanced Usage

### Working with Specific Versions

If a REMARK metadata file specifies a `tag` field:

```yaml
name: BufferStockTheory
remote: https://github.com/econ-ark/BufferStockTheory
title: Buffer Stock Theory
tag: v1.0.0
```

The CLI will automatically checkout that specific version.

### Parallel Processing

Most operations support parallel execution:

```bash
# Build 8 REMARKs simultaneously
python cli.py build conda --all -J 8

# Execute with 2 parallel jobs (safer for memory-intensive REMARKs)
python cli.py execute docker --all --jobs 2
```

### Environment Management

The CLI creates isolated environments:

```bash
_REMARK/
‚îú‚îÄ‚îÄ repos/                    # Cloned repositories
‚îÇ   ‚îú‚îÄ‚îÄ BufferStockTheory/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .condaenv/       # Conda environment (if built)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ beyond-the-streetlight/
‚îî‚îÄ‚îÄ logs/                     # Execution logs
    ‚îú‚îÄ‚îÄ build/
    ‚îÇ   ‚îú‚îÄ‚îÄ BufferStockTheory_conda.log
    ‚îÇ   ‚îî‚îÄ‚îÄ BufferStockTheory_conda_rc.log
    ‚îî‚îÄ‚îÄ execute/
        ‚îú‚îÄ‚îÄ BufferStockTheory_conda.log
        ‚îî‚îÄ‚îÄ BufferStockTheory_conda_rc.log
```

## Error Handling

### Common Issues

**Missing files:** Use `lint` to identify missing required files
```bash
python cli.py lint --all
```

**Build failures:** Check build logs
```bash
python cli.py logs
cat _REMARK/logs/build/ProjectName_conda.log
```

**Docker issues:** Ensure Docker daemon is running
```bash
docker --version
systemctl status docker  # On Linux
```

**Conda issues:** Verify conda installation
```bash
conda --version
```

## Integration with GitHub Workflows

The CLI is designed to integrate with GitHub Actions:

```yaml
- name: Validate REMARKs
  run: python cli.py lint --all

- name: Test REMARKs
  run: |
    python cli.py build conda --all
    python cli.py execute conda --all
```

## Maintainer Workflows

### Adding New REMARKs

1. Validate compliance: `python cli.py lint REMARKs/new-remark.yml`
2. Test build: `python cli.py build conda REMARKs/new-remark.yml`
3. Test execution: `python cli.py execute conda REMARKs/new-remark.yml`
4. Check logs: `python cli.py logs REMARKs/new-remark.yml`

### Bulk Operations

```bash
# Full validation pipeline
python cli.py pull --all
python cli.py lint --all
python cli.py build conda --all
python cli.py execute conda --all
python cli.py logs
```

## Performance Considerations

- **Docker builds:** Slower but more robust, good for multi-language REMARKs
- **Conda builds:** Faster, good for Python-only REMARKs  
- **Parallel jobs:** More parallelism speeds builds but uses more memory
- **Disk space:** Each REMARK requires ~100MB-1GB depending on dependencies

---

This CLI tool enables efficient management of the entire REMARK ecosystem, from validation through execution, with comprehensive logging and error handling.
